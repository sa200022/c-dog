1. 系統整體架構

專案型態：ASP.NET Core Minimal API（單一 Web 專案即可，先不用拆多專案）

分層概念（在同一專案內用命名空間劃分）：

Domain：實體、Enum、Value Object、商業規則

Infrastructure：EF Core DbContext、EntityTypeConfiguration、Repository（如需要）

Application：Use Case / Service（訂單建立、退款申請、報表查詢）

Api：Minimal API Endpoint mapping、DTO、Request/Response Model、驗證

資料庫：關聯式（預設用 SQL Server / PostgreSQL，實作時再選一個）

2. Domain 模型設計（核心實體）
2.1 Activity（活動）

用途：展示頁與搜尋的主體。

關鍵欄位：

Id

Name

Category

Location

Description

MinPrice / MaxPrice（由時段座位計算或人工設定）

Status（Draft / Published / Archived）

CreatedAt / UpdatedAt

關鍵規則：

Published 才能被下單

活動下有至少一個可售的 Timeslot 才算可訂

2.2 Timeslot（時段）

用途：同一活動在不同時間的場次。

關鍵欄位：

Id

ActivityId

StartTime / EndTime

BasePrice

Capacity（可售總名額；對無座位活動就是名額）

RemainingCapacity

Status（OnSale / SoldOut / Closed）

規則：

RemainingCapacity 不可 < 0

若關聯座位制，Capacity 可以為 null 或用座位數推算

2.3 Seat（座位）〔可選〕

用途：座位制活動使用。

關鍵欄位：

Id

TimeslotId

Area（區域/樓層）

Row / Number（可合併為 SeatLabel）

PriceOverride（可空；若空則用 Timeslot.BasePrice）

Status（Available / Reserved / Sold / Locked）

規則：

下單流程中需要「暫時鎖定座位」（後續可擴充，MVP 可先簡化為直接扣）

2.4 Order（訂單）

用途：整個購買行為的核心。

關鍵欄位：

Id

OrderNumber（人類可讀）

UserId/CustomerEmail/CustomerName（暫用簡單欄位）

ActivityId

TimeslotId

TotalAmount

Currency

Status（PendingPayment / Paid / Cancelled / Refunded / PartiallyRefunded）

CreatedAt / PaidAt / CancelledAt / RefundedAt

訂單明細（OrderItem）：

OrderId

SeatId（可空：無座位活動）

Quantity

UnitPrice

LineAmount

規則：

Paid 後才算佔用名額 / 座位（MVP 可在建立訂單時直接視為已付款，先略過支付整合）

Cancelled / Refunded 要對應釋放庫存邏輯（時段容量 / 座位）

2.5 Refund（退款）

關鍵欄位：

Id

OrderId

Amount

Reason

Status（Requested / Approved / Rejected / Completed）

RequestedAt / ProcessedAt

規則：

退款金額不得大於已付款金額

一張訂單可有多筆 Refund（支援部分退款）

2.6 ItineraryNotification（行程提醒）

關鍵欄位：

Id

OrderId

ScheduledSendTime（例如活動前 24 小時）

ActualSentTime（可空）

Channel（Email / SMS / Other）

Status（Pending / Sent / Failed）

Payload（JSON：保存要寄出的內容快照）

規則：

MVP 不實作真正寄信，只需要記錄要寄什麼、何時寄

3. 資料庫結構（主要表）

Activities

Timeslots

Seats（可選）

Orders

OrderItems

Refunds

ItineraryNotifications

後續可加：

Users（若要正式會員系統）

ActivityImages、Categories 等

4. Application / Service Use Case

用高階 Service（class）封裝一條條業務流程，Minimal API 只呼叫這些 Service。

4.1 ActivityService

GetActivities(filter...)

GetActivityDetail(id)

CreateActivity(...)

UpdateActivity(...)

ChangeActivityStatus(...)

4.2 TimeslotService

GetTimeslotsByActivity(activityId, onlyOnSale)

CreateTimeslot(...)

UpdateTimeslot(...)

AdjustCapacity/RemainingCapacity(...)

4.3 SeatService（若啟用座位）

GetSeats(timeslotId, onlyAvailable)

LockSeats(timeslotId, seatIds)（MVP 可省略鎖定，直接在下單扣）

MarkSeatsSold(orderId, seatIds)

ReleaseSeats(seatIds)

4.4 OrderService

核心流程：選活動 → 選時段 → 下單 → 取消

CreateOrder(request)

驗證活動/時段狀態

檢查剩餘容量 / 座位可用性

建立 Order + OrderItems

扣除 Timeslot.RemainingCapacity 或標記 Seat.Sold

CancelOrder(orderId)

狀態檢查（只能取消 PendingPayment / Paid 且未過期等簡化規則）

更新 Order.Status = Cancelled

回補容量 / 釋放座位

GetOrderDetail(orderId)

ListOrdersByUser(userId, paging)

MVP 支付：

先假設 CreateOrder 就是已付款完成（Status = Paid），把支付流程當作外部已處理。

4.5 RefundService

RequestRefund(orderId, amount, reason)

ApproveRefund(refundId)

RejectRefund(refundId)

CompleteRefund(refundId)（模擬第三方支付回調）

自動更新 Order 的 Refunded 金額與狀態

4.6 NotificationService

當 Order Paid：

建立一筆 ItineraryNotification，ScheduledSendTime = Timeslot.StartTime - X 小時

手動觸發「重新寄送」：

產生新的 Notification 記錄或更新既有記錄的狀態

5. API 設計（Minimal API Endpoints）

只列出主要路由與動詞，實作時再拆 DTO。

5.1 活動 /activities

GET /activities
查詢活動列表（支援分類、關鍵字、地點等簡單 filter）

GET /activities/{activityId}
活動詳細資料

POST /activities
建立活動（先當作後台 API）

PUT /activities/{activityId}
更新活動

PATCH /activities/{activityId}/status
上架 / 下架

5.2 時段 /activities/{id}/timeslots

GET /activities/{activityId}/timeslots
該活動所有時段（可選 onlyOnSale）

POST /activities/{activityId}/timeslots
新增時段

PUT /timeslots/{timeslotId}
更新時段

PATCH /timeslots/{timeslotId}/status
關閉 / 開放

5.3 座位 /timeslots/{id}/seats（如果啟用座位）

GET /timeslots/{timeslotId}/seats
查詢座位列表（可 filter 狀態）

（MVP 可以先不做獨立鎖定 API）

5.4 訂單 /orders

POST /orders
建立訂單（包含活動 ID、時段 ID、數量或座位列表、顧客資訊）

GET /orders/{orderId}
查單一訂單

GET /orders
依 user 或條件查訂單列表（簡單分頁）

POST /orders/{orderId}/cancel
取消訂單（並釋放庫存 / 座位）

（若要模擬付款，可加 POST /orders/{orderId}/pay，但 MVP 可合併在建立時）

5.5 退款 /refunds

POST /orders/{orderId}/refunds
申請退款

GET /refunds/{refundId}

GET /refunds（管理端查詢）

POST /refunds/{refundId}/approve

POST /refunds/{refundId}/reject

POST /refunds/{refundId}/complete

（MVP 可以壓縮成一個簡化流程）

5.6 行程提醒 /notifications

GET /orders/{orderId}/notifications
查該訂單的提醒記錄

POST /orders/{orderId}/notifications/resend
重新排程一次提醒（建立新記錄或更新）

6. 驗收流程對應

目標流程：「選活動 → 選時段 → 下單 → 取消 → 看報表」

對應 API 呼叫順序（最小路線）：

GET /activities

GET /activities/{activityId}/timeslots

POST /orders（下單，直接當作已付款）

POST /orders/{orderId}/cancel

報表（先做簡易版管理 API）：

GET /reports/activity-sales?activityId=...

GET /reports/timeslot-inventory?activityId=...

報表可以先放在 /reports/... 底下，以查詢為主，不做複雜聚合。

7. MVP 實作優先順序

Domain Model + DbContext + Migration（Activities / Timeslots / Orders / OrderItems）

GET /activities / GET /activities/{id} / GET /activities/{id}/timeslots

POST /orders + 基本庫存扣減（不含座位）

POST /orders/{id}/cancel + 庫存回補

報表 API（簡單聚合）

再補 Refund / Notification / Seat 模組